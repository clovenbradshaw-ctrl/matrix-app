<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Notes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h2 { color: #333; margin-bottom: 5px; font-size: 24px; }
        .subtitle { color: #666; font-size: 13px; margin-bottom: 20px; }
        .status { padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 14px; }
        .status.ok { background: #d4edda; color: #155724; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        textarea { 
            width: 100%; 
            padding: 15px; 
            font-size: 14px; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            min-height: 350px; 
            font-family: inherit;
            resize: vertical;
        }
        textarea:focus { outline: none; border-color: #667eea; }
        .button-group { margin-top: 15px; display: flex; gap: 10px; }
        button { 
            flex: 1;
            padding: 14px 24px; 
            border: none; 
            border-radius: 8px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover { background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .help { font-size: 12px; color: #888; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="status ok" id="s">‚úÖ Connected to room</div>
        <h2>üìù Room Notes</h2>
        <p class="subtitle">Notes are saved as messages in this room</p>
        <textarea id="t" placeholder="Type your notes here..."></textarea>
        <div class="button-group">
            <button onclick="save()">üíæ Save to Room</button>
        </div>
        <p class="help">üí° Your notes are stored as hidden messages in this Matrix room</p>
    </div>

    <script>
        const NOTE_TYPE = 'social.hyphae.note';
        let requests = {};

        // Send message and wait for response
        function ask(action, data) {
            return new Promise((resolve, reject) => {
                const id = Date.now() + '-' + Math.random();
                requests[id] = { resolve, reject };
                
                window.parent.postMessage({
                    api: 'fromWidget',
                    widgetId: 'notes',
                    requestId: id,
                    action: action,
                    data: data || {}
                }, '*');
                
                setTimeout(() => {
                    if (requests[id]) {
                        delete requests[id];
                        reject(new Error('Timeout'));
                    }
                }, 5000);
            });
        }

        // Handle messages from Element
        window.addEventListener('message', (e) => {
            if (!e.data || e.data.api !== 'toWidget') return;
            
            // Capabilities
            if (e.data.action === 'capabilities') {
                window.parent.postMessage({
                    api: 'fromWidget',
                    widgetId: 'notes',
                    requestId: e.data.requestId,
                    action: 'capabilities',
                    response: { 
                        capabilities: [
                            'org.matrix.msc2762.send.event:m.room.message',
                            'org.matrix.msc2762.receive.event:m.room.message'
                        ] 
                    }
                }, '*');
                return;
            }
            
            // Responses
            if (e.data.requestId && requests[e.data.requestId]) {
                const req = requests[e.data.requestId];
                delete requests[e.data.requestId];
                
                if (e.data.response) {
                    req.resolve(e.data.response);
                } else {
                    req.reject(new Error('No response'));
                }
            }
        });

        // Initialize
        window.addEventListener('load', () => {
            // Send ready
            window.parent.postMessage({
                api: 'fromWidget',
                widgetId: 'notes',
                action: 'ready',
                data: {}
            }, '*');
            
            console.log('Widget ready');
        });

        // Save notes as a room message
        async function save() {
            const text = document.getElementById('t').value;
            
            if (!text.trim()) {
                document.getElementById('s').textContent = '‚ö†Ô∏è Nothing to save';
                document.getElementById('s').className = 'status info';
                return;
            }
            
            document.getElementById('s').textContent = '‚è≥ Saving to room...';
            document.getElementById('s').className = 'status info';
            
            try {
                // Send as a room message
                await ask('send_event', {
                    type: 'm.room.message',
                    content: {
                        msgtype: NOTE_TYPE,
                        body: `[Notes Updated]\n\n${text}`,
                        format: 'org.matrix.custom.html',
                        formatted_body: `<p><em>[Notes Updated]</em></p><pre>${text}</pre>`,
                        'social.hyphae.note': text,
                        'social.hyphae.timestamp': Date.now()
                    }
                });
                
                document.getElementById('s').textContent = '‚úÖ Saved to room!';
                document.getElementById('s').className = 'status ok';
                console.log('Saved to room:', text.length, 'chars');
            } catch (error) {
                console.error('Save error:', error);
                document.getElementById('s').textContent = '‚ùå Failed to save: ' + error.message;
                document.getElementById('s').className = 'status info';
            }
        }
    </script>
</body>
</html>
