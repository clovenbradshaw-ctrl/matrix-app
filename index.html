<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .log {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h2>Widget Debug Log</h2>
    <div id="logs"></div>

    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }

        log('Widget loaded');
        log('Window parent === window? ' + (window.parent === window));
        log('Location: ' + window.location.href);
        
        // Check if matrix-widget-api is available
        log('Checking for widget libraries...');
        log('window.mxwidgets: ' + typeof window.mxwidgets);
        log('window.MatrixWidget: ' + typeof window.MatrixWidget);
        log('window.WidgetApi: ' + typeof window.WidgetApi);
        
        // Try to load from CDN
        log('Attempting to load matrix-widget-toolkit from esm.sh...');
        
        import('https://esm.sh/@matrix-widget-toolkit/api@5.0.2')
            .then(module => {
                log('✓ Module loaded successfully!', 'success');
                log('Module exports: ' + Object.keys(module).join(', '));
                
                if (module.WidgetApiImpl) {
                    log('✓ WidgetApiImpl found, creating instance...', 'success');
                    return module.WidgetApiImpl.create();
                } else {
                    throw new Error('WidgetApiImpl not found in module');
                }
            })
            .then(api => {
                log('✓ Widget API created successfully!', 'success');
                log('API methods: ' + Object.keys(api).slice(0, 10).join(', ') + '...');
            })
            .catch(error => {
                log('✗ Error: ' + error.message, 'error');
                log('Stack: ' + error.stack, 'error');
            });
        
        // Listen for postMessages
        window.addEventListener('message', (event) => {
            log('Received postMessage from: ' + event.origin, 'info');
            log('Message data: ' + JSON.stringify(event.data).substring(0, 100) + '...', 'info');
        });
        
        log('Setup complete, waiting for events...');
    </script>
</body>
</html>
