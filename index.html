<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Notes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; padding: 20px; background: #f5f5f5; }
        .status { padding: 10px; margin-bottom: 15px; border-radius: 6px; font-size: 14px; }
        .status.ok { background: #d4edda; color: #155724; }
        .status.err { background: #f8d7da; color: #721c24; }
        textarea { width: 100%; padding: 12px; font-size: 14px; border: 2px solid #ddd; border-radius: 6px; min-height: 300px; font-family: inherit; }
        button { padding: 12px 24px; margin: 10px 10px 0 0; border: none; border-radius: 6px; background: #667eea; color: white; font-size: 14px; font-weight: 600; cursor: pointer; }
        button:hover { background: #5568d3; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="status" id="s">‚è≥ Connecting...</div>
    <h2>üìù Room Notes</h2>
    <textarea id="t" placeholder="Your notes..." disabled></textarea>
    <br>
    <button id="save" onclick="save()" disabled>üíæ Save to Room</button>
    <button id="load" onclick="load()" disabled>üîÑ Load from Room</button>

    <script>
        const DATA_KEY = 'social.hyphae.notes';
        let requests = {};
        let roomId = null;

        // Send message to parent and wait for response
        function sendAndWait(action, data) {
            return new Promise((resolve, reject) => {
                const reqId = Date.now() + '-' + Math.random();
                requests[reqId] = { resolve, reject };
                
                window.parent.postMessage({
                    api: 'fromWidget',
                    widgetId: 'notes',
                    requestId: reqId,
                    action: action,
                    data: data || {}
                }, '*');
                
                setTimeout(() => {
                    if (requests[reqId]) {
                        delete requests[reqId];
                        reject(new Error('Timeout'));
                    }
                }, 10000);
            });
        }

        // Listen for messages from parent
        window.addEventListener('message', (e) => {
            if (!e.data || e.data.api !== 'toWidget') return;
            
            console.log('Got message:', e.data);
            
            // Handle capabilities request
            if (e.data.action === 'capabilities') {
                window.parent.postMessage({
                    api: 'fromWidget',
                    widgetId: 'notes',
                    requestId: e.data.requestId,
                    action: 'capabilities',
                    response: { capabilities: [] }
                }, '*');
                return;
            }
            
            // Handle responses to our requests
            if (e.data.requestId && requests[e.data.requestId]) {
                const req = requests[e.data.requestId];
                delete requests[e.data.requestId];
                req.resolve(e.data.response || e.data.data || {});
            }
        });

        // Start widget
        window.addEventListener('load', async () => {
            console.log('Widget loaded');
            
            // Get room ID from URL
            const params = new URLSearchParams(window.location.search);
            roomId = params.get('roomId');
            console.log('Room ID:', roomId);
            
            // Send ready
            setTimeout(async () => {
                console.log('Sending ready...');
                window.parent.postMessage({
                    api: 'fromWidget',
                    widgetId: 'notes',
                    action: 'ready',
                    data: {}
                }, '*');
                
                document.getElementById('s').textContent = '‚úÖ Connected to room';
                document.getElementById('s').className = 'status ok';
                document.getElementById('t').disabled = false;
                document.getElementById('save').disabled = false;
                document.getElementById('load').disabled = false;
                
                // Auto-load on start
                await load();
            }, 500);
        });

        async function save() {
            const text = document.getElementById('t').value;
            document.getElementById('s').textContent = '‚è≥ Saving to room...';
            document.getElementById('s').className = 'status';
            
            try {
                // Save to room account data
                await sendAndWait('send_event', {
                    type: 'm.room.account_data',
                    content: {
                        text: text,
                        updated: Date.now()
                    },
                    state_key: DATA_KEY,
                    room_id: roomId
                });
                
                document.getElementById('s').textContent = '‚úÖ Saved to room!';
                document.getElementById('s').className = 'status ok';
                console.log('Saved to room:', text.length, 'chars');
            } catch (error) {
                console.error('Save error:', error);
                // Fallback to localStorage
                localStorage.setItem(DATA_KEY, text);
                document.getElementById('s').textContent = '‚úÖ Saved locally (Matrix save failed)';
                document.getElementById('s').className = 'status ok';
            }
        }

        async function load() {
            document.getElementById('s').textContent = '‚è≥ Loading from room...';
            document.getElementById('s').className = 'status';
            
            try {
                // Load from room account data
                const response = await sendAndWait('get_event', {
                    type: 'm.room.account_data',
                    state_key: DATA_KEY,
                    room_id: roomId
                });
                
                if (response && response.content && response.content.text) {
                    document.getElementById('t').value = response.content.text;
                    document.getElementById('s').textContent = '‚úÖ Loaded from room!';
                    document.getElementById('s').className = 'status ok';
                    console.log('Loaded from room:', response.content.text.length, 'chars');
                } else {
                    throw new Error('No data');
                }
            } catch (error) {
                console.error('Load error:', error);
                // Fallback to localStorage
                const text = localStorage.getItem(DATA_KEY) || '';
                document.getElementById('t').value = text;
                document.getElementById('s').textContent = text ? 'üìù Loaded from local storage' : 'üìù No saved notes';
                document.getElementById('s').className = 'status ok';
            }
        }
    </script>
</body>
</html>
